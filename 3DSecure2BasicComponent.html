<html>

<head>
	<title>3DS 2.0</title>
	<link rel="stylesheet" type="text/css" href="styles/style.css"/>
	<link rel="stylesheet" type="text/css" href="styles/flowchart.css"/>
	<script src="https://checkoutshopper-test.adyen.com/checkoutshopper/sdk/2.5.0/adyen.js"></script>
</head>

<body>
	<div class="left-column">
		<h2>Network activity</h2>
		<div id="output"></div>
	</div>
	
	<div class="right-column fixed">
		<div class="flowchart-container">
			<figure class="flowchart">
				<ul id="flowchart" class="tree"></ul>
			</figure>
			<div class="flowchart-legend center-content">
				<div>
					<label>Current state</label>
					<span class="flowchart-color-swatch active-state-legend"></span>
				</div>
				<div>
					<label>Previous state</label>
					<span class="flowchart-color-swatch previous-state-legend"></span>
				</div>
				<div>
					<label>Unreachable state</label>
					<span class="flowchart-color-swatch unreachable-state-legend"></span>
				</div>
			</div>
		</div>

		<div class="center-content">
			<div class="checkout-holder">
				<div class="client-form">
					<div class="block">
						<input type="checkbox" id="frictionlessCheckbox"/>
						<label for="frictionlessCheckbox">Frictionless</label>
					</div>
					<div class="block">
						<input type="checkbox" id="standaloneCheckbox"/>
						<label for="standaloneCheckbox">Standalone</label>
					</div>
					<div id="authoriseBtnHolder"></div>
				</div>
			</div>

			<div id="sdkContainer" class="hidden challenge-iframe"></div>
		</div>
	</div>

</body>

</html>

<script type="module">

// custom utilities
import * as common from "./scripts/common.js";
import Flowchart from "./scripts/flowchart.js";
import * as SDK from "./scripts/custom3dsSDK.js";

// constants
const NOTIFICATION_URL = common.SUBMIT_URL + "?endpoint=threeds2_result_page";
const CACHED_THREEDS_URL = "https://pal-test.adyen.com/threeds2simulator/acs/startMethod.shtml";

// container for global variables
const globals = {};

// get everything ready to go
initialize();
function initialize() {

	// Add submit button to DOM
	const authoriseButton = document.createElement("button");
	authoriseButton.onclick = submitForm;
	authoriseButton.innerHTML = "Authorise";
	authoriseButton.id = "authoriseBtn";
	document.querySelector("#authoriseBtnHolder").appendChild(authoriseButton);
	
	// add dynamic flowchart
	let tree = [
		"First /payments Call",
		[
			"Fingerprint Device",
			[
				"Frictionless",
				"Challenge Shopper", 
				[
					"Authorise With Token",
					"Retrieve MPI Data", 
					[
						"Authorise Via Adyen",
						"Authorise Elsewhere"
					],
				]
			]
		]
	];

	globals.flowchart = new Flowchart(tree, document.querySelector("#flowchart"));

	// Adyen 3ds2 component
	globals.checkout = new AdyenCheckout({
		originKey: "pub.v2.8115054323780109.aHR0cDovL2xvY2FsaG9zdDo4MDAw.B92basPQjzeM7_TtJ2IKZoln780QtvwAiPFDEbKs7Ng"
	});
}

// send form data to server
function submitForm(e) {

	let jsonData = {}; // JSON object for logging

	// hide checkout form
	document.querySelector(".checkout-holder").classList.add("display-none");
	
	// handle checkbox options
	let value = 1000;
	if (document.querySelector("#frictionlessCheckbox").checked) {
		value = 12002;
	}
	globals.authenticationOnly = document.querySelector("#standaloneCheckbox").checked;

	// get browser info
	const browserInfo = collectBrowserInfo();
	browserInfo.acceptHeader = "";  // filled in by server when field is present

	// request with hardcoded card information
	const request = {
		"amount":{
			"currency": "EUR",
			"value": value
		},
		"reference": "Localhost 3ds2 basic component",
		"paymentMethod": {
			"type":"scheme",
			"number": "4212345678901245",
			"expiryMonth": "10",
			"expiryYear": "2020",
			"holderName": "John Smith",
			"cvc": "737"
		},
		"additionalData" : {
			"allow3DS2" : true
		},
		"threeDS2RequestData": {
			"authenticationOnly": globals.authenticationOnly
		},
		"browserInfo": browserInfo,
		"channel" : "web",
		"origin" : window.location.href,
		"merchantAccount": ""  // filled in by server
	};

	// add BIN / MID if necessary
	if (globals.authenticationOnly) {
		request.additionalData.acquirerCode = "TestPmmAcquirer";
		request.additionalData.authorisationMid = "1000";
	}

	// send to server
	request.endpoint = common.endpoints.payments;
	common.AJAXPost(common.SERVER_URL, initialAuthoriseCallback, request);

	globals.flowchart.setActive("First/paymentsCall");

	// block default form behavior
	return false;
}

// receive response from initialAuthoriseCall
function initialAuthoriseCallback(data) {
	// parse and output request / response
	const request = data.request;
	const response = data.response;

	common.output(request, "Initial request to /payments", data.endpoint);
	common.output(response, "Response to initial /payments call");

	if (response.resultCode === "IdentifyShopper") {

		// save required data for later
		globals.paymentData = response.paymentData;

		// execute the fingerprint via the SDK
		fingerprintDevice(response.authentication["threeds2.fingerprintToken"]);
	}
	else if (response.resultCode === "AuthenticationFinished" || response.resultCode === "Authorised") {
		// authentication is complete - we can stop here!
		globals.flowchart.setActive("Frictionless");
	}
}

// perform fingerprint via Adyen component
function fingerprintDevice(fingerprintToken) {

	doFingerprint(fingerprintToken);
	common.output(stringifyFunction(doFingerprint), "Fingerprint request to component");

	globals.flowchart.setActive("FingerprintDevice");
}

function doFingerprint(fingerprintToken) {
	globals.checkout
        .create("threeDS2DeviceFingerprint", {
            fingerprintToken: fingerprintToken,
            onComplete: fingerprintData => {
            	common.output(JSON.stringify(fingerprintData), "Fingerprint result");
            	postFingerprintPaymentsDetails(fingerprintData.data.details["threeds2.fingerprint"]);
            },
            onError: () => {
            	common.output("Verification request to component failed", "Fingerprint response from component");
            }
        })
        .mount("#sdkContainer");
}

// call to payments/details following successful fingerprint
function postFingerprintPaymentsDetails(fingerprintResult) {
	const request = {
		"details": {
			"threeds2.fingerprint": fingerprintResult
		},
		"paymentData": globals.paymentData
	};
	request.endpoint = common.endpoints.paymentsDetails;

	common.AJAXPost(common.SERVER_URL, postFingerprintPaymentsDetailsComplete, request);
}

// callback from call to payments/details following fingerprint
function postFingerprintPaymentsDetailsComplete(data) {

	// parse and output request / response
	const request = data.request;
	const response = data.response;

	common.output(request, "Post-fingerprint payments/details call", data.endpoint);
	common.output(response, "Response to post-fingerprint payments/details call");

	if (response.resultCode === "ChallengeShopper") {
		common.output(stringifyFunction(doChallenge), "Challenge request to component");

		// show challenge iframe
		document.querySelector("#sdkContainer").classList.remove("hidden");

		globals.flowchart.setActive("ChallengeShopper");
		doChallenge(response.authentication['threeds2.challengeToken']);
	}
	else if (response.resultCode === "AuthenticationFinished" || response.resultCode === "Authorised") {
		globals.flowchart.setActive("Frictionless");
	}
}

// perform challenge via SDK
function doChallenge(challengeToken) {
	globals.checkout
		.create('threeDS2Challenge', {
			challengeToken: challengeToken,
			onComplete: challengeData => {
				common.output(challengeData, "Challenge result");
				postChallengePaymentsDetails(challengeData.data.details["threeds2.challengeResult"]);
			},
			onError: () => {
				common.output("Verification request to component failed", "Fingerprint response from component");
			},
			size: '01'
		})
		.mount('#sdkContainer');
}

// call to payments/details following successful challenge
function postChallengePaymentsDetails(challengeResult) {

	// performing these here to keep the doChallenge method clean
	common.hide("#sdkContainer");
	
	const request = {
		"details": {
			"threeds2.challengeResult": challengeResult
		},
		"paymentData": globals.paymentData
	};
	request.endpoint = common.endpoints.paymentsDetails;

	common.AJAXPost(common.SERVER_URL, postChallengePaymentsDetailsCallback, request);
}

// callback from call to payments/details following challenge
function postChallengePaymentsDetailsCallback(data, url) {
	const request = data.request;
	const response = data.response;

	common.output(request, "Post-challenge payments/details call", data.endpoint);
	common.output(response, "Response to post-challenge payments/details call");

	if (response.resultCode === "AuthenticationFinished") {
		authoriseWithMPIData(response.threeDS2Result);
		globals.flowchart.setActive("RetrieveMPIData");
	}
	else if (response.resultCode === "Refused") {
		globals.flowchart.setActive("RetrieveMPIData");
	}
	else {
		globals.flowchart.setActive("AuthoriseWithToken");
	}
}

// authorise with raw MPI data
function authoriseWithMPIData(threeDS2Result) {
	const request = {
		"amount":{
			"currency":"EUR",
			"value":1000
		 },
		 "merchantAccount":"", 
		 "reference":"Localhost 3ds2 with MPI data",
		 "additionalData" : {
			// "allow3DS2": "true",
			"acquirerCode":"TestPmmAcquirer",
			"authorisationMid":"1000"
		},
		"mpiData":{  
			"cavv": threeDS2Result.authenticationValue,
			"eci": threeDS2Result.eci,
			"dsTransId": threeDS2Result.dsTransID,
			"directoryResponse": "C", // assuming there was a challenge
			"authenticationResponse": threeDS2Result.transStatus,
			"threeDSVersion": "2.1.0" // will we ever return this in the /payments/details call?
		},
		"paymentMethod": {
			"type": "scheme",
			"number": "4212345678901245",
			"expiryMonth": "10",
			"expiryYear": "2020",
			"holderName": "John Smith",
			"cvc": "737"
		}
	};
	request.endpoint = common.endpoints.payments;

	common.AJAXPost(common.SERVER_URL, authoriseWithMPIDataCallback, request);
}

// finish authorisation using raw MPI data
function authoriseWithMPIDataCallback(data) {
	const request = data.request;
	const response = data.response;

	common.output(request, "Payments call with raw MPI data", data.endpoint);
	common.output(response, "Response to payments call with raw MPI data");

	globals.flowchart.setActive("AuthoriseViaAdyen");
}

//////////////////////////////
//		UTILITY METHODS		//
//////////////////////////////

// convert functions to pretty output
function stringifyFunction(func) {
	return func.toString().replace(/    /g, "\t").replace(/\t/g, "    ");
}

// generate browserInfo object
function collectBrowserInfo() {

    const screenWidth = window && window.screen ? window.screen.width : '';
    const screenHeight = window && window.screen ? window.screen.height : '';
    const colorDepth = window && window.screen ? window.screen.colorDepth : '';
    const userAgent = window && window.navigator ? window.navigator.userAgent : '';
    const javaEnabled = window && window.navigator ? navigator.javaEnabled() : false;

    let language = '';
    if (window && window.navigator) {
        language = window.navigator.language
            ? window.navigator.language
            : window.navigator.browserLanguage; // Else is for IE <+ 10
    }

    const d = new Date();
    const timeZoneOffset = d.getTimezoneOffset();

    const browserInfo = {
        screenWidth,
        screenHeight,
        colorDepth,
        userAgent,
        timeZoneOffset,
        language,
        javaEnabled,
    };

    return browserInfo;
}

</script>