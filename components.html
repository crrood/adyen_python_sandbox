<html>

<head>
	<script type="text/javascript" src="https://checkoutshopper-test.adyen.com/checkoutshopper/sdk/2.1.0/adyen.js"></script>
	<link rel="stylesheet" href="https://checkoutshopper-test.adyen.com/checkoutshopper/sdk/2.1.0/adyen.css" />
	<link rel="stylesheet" type="text/css" href="styles/style.css"></link>
	<title>Components</title>
</head>

<body>

	<h3>Payment info</h3>
	<div class="block">
		<form id="paymentForm" class="client-form" >
			Value: <input type="text" class="payment-data" name="value" value="1500"/><br>
			Currency: <input type="text" class="payment-data" name="currency" value="EUR"/><br>
			CountryCode: <input type="text" class="payment-data" name="countryCode" value="NL"/><br>
			ShopperLocale: <input type="text" class="payment-data" name="shopperLocale" value="en_GB"/><br>
			Reference: <input type="text" class="payment-data" name="reference" value="Localhost Components"/><br>
			<button id="checkoutBtn" class="block">Initialize</button>
		</form>
	</div>

	<div id="componentHolder" class="component display-none"></div>
	<div id="cardComponentHolder" class="component display-none"></div>
	<div id="sepaComponentHolder" class="component display-none"></div>
	<div id="genericComponentHolder" class="component"></div>
	<br>
	<button id="payBtn" class="hidden" disabled=true>Pay</button>


	<div id="output"></div>
</body>

<script type="module">

import * as common from "./scripts/common.js";

const ORIGIN_KEY = "pub.v2.8115054323780109.aHR0cDovL2xvY2FsaG9zdDo4MDAw.B92basPQjzeM7_TtJ2IKZoln780QtvwAiPFDEbKs7Ng";

const globals = {};

// actions to do on page load
window.onload = function() {

	// event listener for initialize button
	document.getElementById("checkoutBtn").addEventListener("click", getAvailablePaymentMethods);

	globals.payBtn = document.querySelector("#payBtn");
	globals.payBtn.onclick = sendPayment;
};

// get data from form and make call to paymentMethods
function getAvailablePaymentMethods(e) {
	e.preventDefault();

	common.hide("#paymentForm");
	common.AJAXPost(common.buildFormURL({ endpoint: "checkout_payment_methods" }), handlePaymentMethodsCallback);
}

// display available components
function handlePaymentMethodsCallback(response) {

	// config options shared between components
	const sharedConfiguration = {
	    locale: document.querySelector("[name=shopperLocale]").value,
	    originKey: ORIGIN_KEY,
	    loadingContext: "https://checkoutshopper-test.adyen.com/checkoutshopper/"
	};

	// show disabled pay button
	globals.payBtn.classList.remove("hidden");

	// intialize checkout object
	const checkout = new AdyenCheckout(sharedConfiguration);

	// iterate through returned payment methods
	// and render components where available
	for (let pm of response.paymentMethods) {
		
		// cards
		if (pm.type === "scheme") {
			const card = checkout.create("card", {
			    onChange: handleStateChange
			    // onValid also works here
			}).mount("#cardComponentHolder");
			common.unhide("#cardComponentHolder");
		}

		// SEPA
		else if (pm.type === "sepadirectdebit") {
			const sepa = checkout.create("sepadirectdebit", {
				onChange: handleStateChange
			}).mount("#sepaComponentHolder");
			common.unhide("#sepaComponentHolder");
		}
		else {
			try {
				checkout.create(pm.type, {
					onChange: handleStateChange
				}).mount("#genericComponentHolder");
			}
			catch {
				console.log("invalid pm type: " + pm.type);
			}
		}
	}
}

// handle changes in component state
function handleStateChange(state, component) {
	globals.payBtn.disabled = !state.isValid;

	globals.activePaymentInfo = state.data;
}

// send payment info to Adyen
function sendPayment() {
	const formData = common.getJSONFromFormData("#paymentForm");
	const request = {
		"merchantAccount":"",
		"reference":"Localhost components",
		"amount":{
			"currency": formData.currency,
			"value": formData.value
		},
		"paymentMethod": globals.activePaymentInfo
	};
	request.endpoint = common.endpoints.payments;

	common.AJAXPost(common.SERVER_URL, handlePaymentsCallback, request);
}

// display result of call to Adyen
function handlePaymentsCallback(data) {
	common.output(data);
}

</script>