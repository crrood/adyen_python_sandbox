<html>

<head>
	<script type="text/javascript" src="https://checkoutshopper-test.adyen.com/checkoutshopper/sdk/2.1.0/adyen.js"></script>
	<link rel="stylesheet" href="https://checkoutshopper-test.adyen.com/checkoutshopper/sdk/2.1.0/adyen.css" />
	<link rel="stylesheet" type="text/css" href="styles/style.css"></link>
	<title>Components</title>
</head>

<body>

	<h3>Payment info</h3>
	<div class="block">
		<form id="paymentForm" class="clientForm" >
			Value: <input type="text" class="payment-data" name="value" value="1500"/><br>
			Currency: <input type="text" class="payment-data" name="currency" value="USD"/><br>
			CountryCode: <input type="text" class="payment-data" name="countryCode" value="US"/><br>
			ShopperLocale: <input type="text" class="payment-data" name="shopperLocale" value="en_GB"/><br>
			Reference: <input type="text" class="payment-data" name="reference" value="Localhost Secured Fields"/><br>
			<button id="checkoutBtn" class="block">Initialize</button>
		</form>
	</div>

	<div id="cardsContainer" class="clientForm hidden">
		<div id="cardComponentHolder"></div>
		<button id="submitCardsBtn" disabled=true>Pay with card</button>
	</div>


	<div id="output"></div>
</body>

<script type="module">

import * as common from "./scripts/common.js";

const ORIGIN_KEY = "pub.v2.8115054323780109.aHR0cDovL2xvY2FsaG9zdDo4MDAw.B92basPQjzeM7_TtJ2IKZoln780QtvwAiPFDEbKs7Ng";

// actions to do on page load
window.onload = function() {

	// event listener for initialize button
	document.getElementById("checkoutBtn").addEventListener("click", getAvailablePaymentMethods);
};

// get data from form and make call to paymentMethods
function getAvailablePaymentMethods(e) {
	e.preventDefault();

	common.AJAXPost(common.buildFormURL({ endpoint: "checkout_payment_methods" }), handlePaymentMethodsCallback);
}

// display available components
function handlePaymentMethodsCallback(response) {

	// parse response
	response = JSON.parse(response);

	// config options shared between components
	const sharedConfiguration = {
	    locale: document.querySelector("[name=shopperLocale]").value,
	    originKey: ORIGIN_KEY,
	    loadingContext: "https://checkoutshopper-test.adyen.com/checkoutshopper/"
	};

	// intialize checkout object
	const checkout = new AdyenCheckout(sharedConfiguration);

	// iterate through returned payment methods
	// and render components where available
	for (let pm of response.paymentMethods) {
		// cards
		if (pm.type === "scheme") {
			const card = checkout.create("card", {
			    onChange: handleCardsChange
			    // onValid also works here
			}).mount("#cardComponentHolder");
			document.querySelector("#cardsContainer").classList.remove("hidden");
		}
	}
}

// enable button when all data is valid
function handleCardsChange(state, component) {
	document.querySelector("#submitCardsBtn").disabled = !state.isValid;

	// add event listener to submit transaction
	if (state.isValid) {
		
		// pass encrypted card data to Adyen
		document.querySelector("#submitCardsBtn").addEventListener("click", () => {
			
			// add holder name
			state.data.holderName = "Test Shopper";

			// send request to server to forward to Adyen
			let url = common.buildFormURL(state.data) + "endpoint=checkout_payments_api";
			common.AJAXPost(url, handlePaymentsCallback);
		});
	}
}

// display result of call to Adyen
function handlePaymentsCallback(response) {
	output(JSON.stringify(JSON.parse(response), null, 4));
}

function output(text) {
	let containerEl = document.querySelector("#output");

	// create element to be added
	let outputContainer = document.createElement("pre");
	let outputEl = document.createElement("code");
	outputContainer.appendChild(outputEl);
	outputEl.innerHTML = text;
	containerEl.append(outputContainer);
}

</script>