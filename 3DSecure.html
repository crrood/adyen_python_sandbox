<HTML>
	<head>
		<link rel="stylesheet" type="text/css" href="styles/style.css"/>
	</head>
	<body>
		<div class="left-column">
			<h2>Network activity</h2>
			<div id="output"></div>
		</div>
		
		<div class="right-column fixed center-content">
			<iframe class="threeDSIframe" id="threeDSIframe">
				<div id="constructedFormHolder"/>
			</iframe>

			<div class="center-content">
				<div class="checkout-holder">
					<div class="client-form">
						<div>
							<input id="adyenTokenAuth" type="radio" name="transactionTypeRadio" value="adyenTokenAuth">
							<label for="adyenTokenAuth">Authorise with Adyen</label><br>
							<input id="acquirerAgnosticAuth" type="radio" checked="checked" name="transactionTypeRadio" value="acquirerAgnosticAuth">
							<label for="acquirerAgnosticAuth">Standalone</label>
						</div>
						<div id="authoriseBtnHolder"></div>
					</div>
				</div>

				<div id="sdkContainer" class="hidden challenge-iframe"></div>
			</div>
		</div>
	</body>
</HTML>

<script type="module">

import * as common from "./scripts/common.js";

// Add submit button to DOM
const authoriseButton = document.createElement("button");
authoriseButton.onclick = initialAuthorise;
authoriseButton.innerHTML = "Authorise";
authoriseButton.id = "authoriseBtn";
document.querySelector("#authoriseBtnHolder").appendChild(authoriseButton);

// Global variables
const globals = {}

// Start the transaction
function initialAuthorise() {
	globals.authenticationOnly = document.querySelector('input[name="transactionTypeRadio"]:checked').value == "acquirerAgnosticAuth";

	// hide checkout form
	common.hide(".checkout-holder");

	const request = {
		"reference": "Localhost 3DS 1",
		"threeDS2RequestData": {
			"authenticationOnly": globals.authenticationOnly
		},
		"paymentMethod": {
			"holderName": "Test Shopper",
			"number": "5212345678901234",
			"type": "scheme",
			"expiryMonth": "10",
			"expiryYear": "2020",
			"cvc": "737"
		},
		"amount": {
			"value": "2000",
			"currency": "USD"
		},
		"browserInfo": {
			"userAgent": "Mozilla/5.0 (Macintosh",
			"acceptheader": "text/html"
		},
		"merchantAccount": "ColinRood",
		"returnUrl": "http://localhost:8000/cgi-bin/submit.py?endpoint=threeds1_notification_url",
		"additionalData": {
			"executeThreeD": "true"
		}
	}

	// send to server
	request.endpoint = common.endpoints.payments;
	common.AJAXPost(common.SERVER_URL, initialAuthoriseCallback, request);

	// prevent default button behavior
	return false;
}


function initialAuthoriseCallback(data) {
	common.output(data.request, "Initial /payments call to Adyen", data.endpoint);
	common.output(data.response, "Response to initial /payments call to Adyen");

	// parse response
	let issuerURL = data.response.redirect.url;
	let redirectData = data.response.redirect.data;

	// because the redirect has to be done as a POST...
	// create an HTML form and redirect the user
	let form = document.createElement("form");
	form.setAttribute("method", "POST");
	form.setAttribute("action", issuerURL);

	// iteract through redirect params
	for (let param in redirectData) {
		let input = document.createElement("input");
		input.setAttribute("type", "hidden");
		input.setAttribute("name", param);
		input.setAttribute("value", redirectData[param]);

		form.appendChild(input);
	}

	document.querySelector("#threeDSIframe").contentWindow.document.documentElement.appendChild(form);
	form.submit();

	window.addEventListener("message", handlePostMessage);
}

// gets response from server
function handlePostMessage(e) {
	common.hide("#threeDSIframe");

	common.output(e.data.redirectData, "Data in redirect from issuer");
	common.output(e.data.request, "Request to /authorise3d", e.data.endpoint);
	common.output(e.data.response, "Response from Adyen");
}

</script>